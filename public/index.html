<!DOCTYPE html>
<html>
  <head>
    <script src="http://static.firebase.com/v0/firebase.js"></script>
    <script src="http://staging.tokbox.com/v0.91/js/TB.min.js" ></script>

    <style>
      * { padding: 0; margin: 0; list-style-type: none; }
      body, html {
        width: 100%;
        height: 100%;
        background-color: blue;
        color: white;
      }
      #home { position: absolute: top: 0; left: 0; width: 22%; height: 100%; background-color: rgba(255, 128, 0, 0.2); }
      #live { opacity: 0.0; -moz-transition: all 1s; position: absolute: top: 0; left: 0; width: 78%; height: 100%; background-color: rgba(255, 128, 32, 0.2); position: absolute; left: 22%; top: 0; }
      #live.connected { opacity: 1.0; }
      #myself { width: 100%; height: 60%; background-color: rgba(255, 128, 0, 0.2); }
      #freshtag { height: 6%; background-color: rgba(0, 256, 256, 0.2); }
      #freshtag-id { width: 67%; height: 100%; float: left; border: 0px; font-size: 100%; } 
      #connect { width: 33%; height: 100%; background-color: #efefef; float: left; }
      #status { width: 100%; height: 20%; background-color: rgba(255, 32, 32, 0.2); }
      #trending { overflow: auto; width: 100%; height: 66%; background-color: rgba(255, 32, 64, 0.2); }
      #streams { width: 100%; height: 63%; background-color: rgba(255, 32, 64, 0.2); }
      #feed { overflow: auto; width: 100%; height: 22%; background-color: rgba(0, 32, 64, 0.2); }
      #input { width: 100%; height: 13%; background-color: rgba(0, 32, 64, 0.2); }
      #add-video { float: left; width: 5%; height: 60%; background-color: red; }
      #input textarea { float: left; margin: 0.75em; padding: 1em; width: 60%; height: 60%; border: 0px; }

      div.streams-container { width: 100%; height: 66%; position: absolute; top: 0; left: 0; }
      div.stream { float: left; height: 10%; width: 10%; background-color: rgba(0, 32, 64, 0.2); }
      div.stream:hover { background-color: grey; -moz-transition: all 1s; -moz-transform: scale3d(1.1, 1.1, 1.1); -webkit-transform: scale3d(1.1, 1.1, 1.1); }

      div.stream {
      display: inline-block; /* shrink to fit */
      width: 100%; /* whatever width you like */
      position: relative; /* so .content can use position: absolute */
      }
      div.stream::after {
      padding-top: 56.25%; /* percentage of containing block _width_ */
      display: block;
      content: '';
      }
      object {
      position: absolute;
      top: 0; bottom: 0; right: 0; left: 0; /* follow the parent's edges */
      outline: thin dashed green; /* just so you can see the box */
      }


      #single-stream { }
      #double-stream { }
      #triple-stream { }
      #quad-stream { }
      #six-stream { }
      #nine-stream { }
      #twelve-stream { }

      #single-stream div.stream { width: 95%; height: 95%; }
      #double-stream div.stream { width: 45%; height: 95%; }
      #triple-stream div.stream { width: 31%; height: 95%; }
      #quad-stream div.stream { width: 45%; height: 45%; }
      #six-stream div.stream { width: 31%; height: 45%; }
      #nine-stream div.stream { width: 31%; height: 31%; }
      #twelve-stream div.stream { width: 24%; height: 31%; }

      li.item { padding: 0.33em; }
      div.avatar { width: 15%; min-height: 3em; float: left; background-color: rgba(0, 128, 64, 0.2);}
      div.content { width: 75%; padding: 0.5em; margin: 0 0 0.33em 0; min-height: 3em; float: left; background-color: rgba(256, 128, 256, 0.2);}
      img { max-width: 99%; }
      iframe { max-width: 99%; max-height: 12em; }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        //var connectButton = document.getElementById("connect");
        var liveContainer = document.getElementById("live");
        var addVideoButton = document.getElementById("add-video");
        var streamsContainer = document.getElementById("streams").children[0];
        var relayoutStreamsForAdditionalElement = function() {
          var length = (streamsContainer.children.length) + 1;
          console.log(length);
          if (length == 1) {
            streamsContainer.id = "single-stream";
          } else if (length == 2) {
            streamsContainer.id = "double-stream";
          //} else if (length == 3) {
          //  streamsContainer.id = "triple-stream";
          } else if (length <= 4) {
            streamsContainer.id = "quad-stream";
          } else if (length > 4 && length <= 6) {
            streamsContainer.id = "six-stream";
          } else if (length > 6 && length <= 9) {
            streamsContainer.id = "nine-stream";
          } else if (length > 9 && length <= 12) {
            streamsContainer.id = "twelve-stream";
          } else {
            throw ("max video streams: " + length);
          }
        };
        var createNewStreamDiv = function() {
          relayoutStreamsForAdditionalElement();
          var newStreamDiv = document.createElement('div');
          newStreamDiv.className = "stream";
          streamsContainer.appendChild(newStreamDiv);
          return newStreamDiv;
        }
        addVideoButton.onclick = function(e) {
          createNewStreamDiv();
        };
    
      var dynamicToken = null;

      var getSessionToken = function(gotSessionFunc) {
        var req = new XMLHttpRequest();
        req.open("POST", "/session", true);
        req.onreadystatechange = function(e) {
          if (this.readyState == 4) {
            gotSessionFunc(req.responseText);
            //alert(req.readyState + req.responseText + req.statusText);
          }
        };
        req.send();
      };

      var loadTokBox = function(sessionId) {
        var publisher;
        var subscribers = {};
        var apiKey = 15935611; // OpenTok sample code key. Replace with your own API key.
        var token = 'devtoken'; // Should not be hard-coded.
        var session = null;

        // Un-comment either of the following to set automatic logging and exception handling.
        // See the exceptionHandler() method below.
        // TB.setLogLevel(TB.DEBUG);
        // TB.addEventListener("exception", exceptionHandler);

        if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
          alert("You don't have the minimum requirements to run this application." + "Please upgrade to the latest version of Flash.");
        } else {
          session = TB.initSession(sessionId);  // Initialize session

          // Add event listeners to the session
          session.addEventListener('sessionConnected', sessionConnectedHandler);
          session.addEventListener('sessionDisconnected', sessionDisconnectedHandler);
          session.addEventListener('connectionCreated', connectionCreatedHandler);
          session.addEventListener('connectionDestroyed', connectionDestroyedHandler);
          session.addEventListener('streamCreated', streamCreatedHandler);
          session.addEventListener('streamDestroyed', streamDestroyedHandler);

          session.connect(apiKey, token);
        }

        // Called when user wants to start publishing to the session
        function startPublishing() {
          if (!publisher) {
            var parentDiv = document.getElementById("myself");
            var publisherDiv = document.createElement('div'); // Create a div for the publisher to replace
            publisherDiv.setAttribute('id', 'opentok_publisher');
            
            parentDiv.appendChild(publisherDiv);
            //var parentDiv = createNewStreamDiv

            publisher = session.publish(publisherDiv.id); // Pass the replacement div id to the publish method
            //show('unpublishLink');
            //hide('publishLink');
            liveContainer.className = "connected";
          }
        }

        //startPublishing();

        function stopPublishing() {
          if (publisher) {
            session.unpublish(publisher);
          }
          publisher = null;

          //show('publishLink');
          //hide('unpublishLink');
        }
        
        //document.getElementById("unpublishLink").onclick = stopPublishing;

    //--------------------------------------
    // OPENTOK EVENT HANDLERS
    //--------------------------------------

    function sessionConnectedHandler(event) {
      // Subscribe to all streams currently in the Session
      for (var i = 0; i < event.streams.length; i++) {
        console.log("add-stream 2");
        addStream(event.streams[i]);
      }
      //show('publishLink');
      startPublishing();
    }

    function streamCreatedHandler(event) {
      // Subscribe to the newly created streams
      for (var i = 0; i < event.streams.length; i++) {
        console.log("add-stream");
        addStream(event.streams[i]);
      }
    }

    function streamDestroyedHandler(event) {
      // This signals that a stream was destroyed. Any Subscribers will automatically be removed.
      // This default behaviour can be prevented using event.preventDefault()
    }

    function sessionDisconnectedHandler(event) {
      // This signals that the user was disconnected from the Session. Any subscribers and publishers
      // will automatically be removed. This default behaviour can be prevented using event.preventDefault()
      publisher = null;

      //hide('publishLink');
      //hide('unpublishLink');
    }

    function connectionDestroyedHandler(event) {
      // This signals that connections were destroyed
    }

    function connectionCreatedHandler(event) {
      // This signals new connections have been created.
    }

    /*
    If you un-comment the call to TB.addEventListener("exception", exceptionHandler) above, OpenTok calls the
    exceptionHandler() method when exception events occur. You can modify this method to further process exception events.
    If you un-comment the call to TB.setLogLevel(), above, OpenTok automatically displays exception event messages.
    */
    function exceptionHandler(event) {
      alert("Exception: " + event.code + "::" + event.message);
    }

    //--------------------------------------
    // HELPER METHODS
    //--------------------------------------

    function addStream(stream) {
      // Check if this is the stream that I am publishing, and if so do not publish.
      if (stream.connection.connectionId == session.connection.connectionId) {
        return;
      }
      //var subscriberDiv = document.createElement('div'); // Create a div for the subscriber to replace
      var subscriberDiv = createNewStreamDiv();
      subscriberDiv.setAttribute('id', stream.streamId); // Give the replacement div the id of the stream as its id.
      //document.getElementById("subscribers").appendChild(subscriberDiv);
      console.log(subscriberDiv.offsetWidth);
      subscribers[stream.streamId] = session.subscribe(stream, subscriberDiv.id, { width: subscriberDiv.offsetWidth, height: subscriberDiv.offsetHeight });
    }
  };

  var onGetSession = function(e) {
        e.preventDefault();
        var login = "foo"; //$("#login").val();
        var hash = document.getElementById("freshtag-id").value;
        var namearr = hash.split("#"); // #topic -> ['', topic']
        var topic = namearr[namearr.length - 1]; // get last element from namearr

        var topicDataRef = new Firebase('http://gamma.firebase.com/brickapp/freshtag/topics/' + topic);
        // find topic in firebase
        topicDataRef.on("value", function(snapshot) {
          var foundSession = snapshot.val();
          if (foundSession != null) {
            // if found use that session id
            console.log("using", login, topic, foundSession);
            loadTokBox(foundSession);
          } else {
            // else getbtoken and add
            getSessionToken(function(newSession) {
              // firebase set by login or topic
              console.log("making", login, topic, newSession)
              topicDataRef.set(newSession);
            });
          }
        });

        return false;
      };

      document.getElementById("connect-form").onsubmit = onGetSession;

      //hide('publishLink');
      //hide('unpublishLink');

      });
    </script>
  </head>
  <body>
    <div id="home">
      <div id="myself">
        <div id="status">
        </div>
      </div>
      <div id="freshtag">
        <form id="connect-form">
          <input id="freshtag-id" value="#demo2012"/>
          <input type="submit" id="connect"/>
        </form>
      </div>
      <div id="trending">
        <ul>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
<!--
                <iframe height="100%" src="http://www.youtube.com/embed/MZUsc1ewgUQ" frameborder="0" allowfullscreen></iframe>
-->
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
<!--
                <iframe src="http://player.vimeo.com/video/48003887?title=0&amp;byline=0&amp;portrait=0" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
-->
              </p>
            </div>
          </li>
        </ul>
      </div>
    </div>
    <div id="live">
      <div id="streams">
        <div id="single-stream" class="streams-container">
        </div>
      </div>
      <div id="feed">
        <ul>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
            wang chung
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                words
              </p>
              <p>
                <a href="http://imgur.com/6qxXp"><img src="http://i.imgur.com/6qxXp.jpg" alt="" title="Hosted by imgur.com" /></a>
              </p>
            <br/>
            wang chung
            <br/>
            wang chung
            <br/>
            wang chung
            <br/>
            <br/>
            wang chung
            <br/>
            <br/>
            wang chung
            wang chung
            <br/>
            <p>
              <a href="http://imgur.com/LTR4P"><img src="http://i.imgur.com/LTR4P.jpg" alt="" title="Hosted by imgur.com" /></a>
            </p>
            wang chung
            wang chung
            <br/>
            wang chung
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
            lol chung
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
            wang chung
            <br/>
            wang chung
              <p>
<!--
                <iframe src="http://player.vimeo.com/video/45684387?title=0&amp;byline=0&amp;portrait=0" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
-->
              </p>
            </div>
          </li>
        </ul>
      </div>
      <div id="input">
        <div id="add-video">
        </div>
        <textarea></textarea>
      </div>
    </div>
  </body>
</html>
