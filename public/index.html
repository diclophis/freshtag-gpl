<!DOCTYPE html>
<html>
  <head>
    <script src="http://static.firebase.com/v0/firebase.js"></script>
    <script src="http://staging.tokbox.com/v0.91/js/TB.min.js" ></script>

    <style>
      body, ul, form, input, textarea, p { padding: 0; margin: 0; width: 100%; height: 100%; }
      img { max-width: 13.5em; max-height: 13.5em }
      iframe { max-width: 13.5em; max-height: 13.5em; }
      div, form { position: absolute; }

      #trending, #feed { overflow: auto; }

      #home { top: 0; left: 0; width: 22%; height: 100%; }
        #myself { top: 0; left: 0; height: 25%; width: 100%; }
          #status { top: 0; left: 0; width: 100%; height: 15%; background-color: rgba(255, 32, 32, 0.2); }
          #publisher { width: 100%; height: 100%; }
          #publisher object { width: 100%; height: 100%; }
        #freshtag { top: 25%; left: 0; width: 100%; height: 10%; }
          #connect-form { height: 100%; width: 100%; }
          #freshtag-id { width: 67%; height: 100%; float: left; border: 0px; font-size: 100%; } 
          #connect { border: 0px; width: 33%; height: 100%; background-color: #efefef; float: left; }
        #trending { top: 35%; width: 100%; height: 65%; }

      #live { top: 0; left: 22%; width: 78%; height: 100%; }
        #streams { top: 0; left: 0; width: 100%; height: 57%; background-color: rgba(255, 32, 64, 0.2); }
        #feed { top: 57%; left: 0; width: 100%; height: 33%; background-color: rgba(0, 32, 64, 0.2); }
        #input { top: 90%; left: 0; width: 100%; height: 9%; background-color: rgba(0, 32, 64, 0.2); }
          #input textarea { width: 60%; height: 100%; border: 0px; }

      .streams-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .stream { -webkit-transition: all 0.33s; -moz-transition: all 1s; position: relative; float: left; background-color: rgba(32, 32, 32, 0.2); }
          .stream object { width: 100%; height: 100%; }

      #single-stream .stream { width: 100%; height: 100%; }
      #double-stream .stream { width: 50%; height: 100%; }
      #quad-stream .stream { width: 50%; height: 50%; }
      #six-stream .stream { width: 33.3%; height: 50%; }
      #nine-stream .stream { width: 33.3%; height: 33%; }
      #twelve-stream .stream { width: 25%; height: 33%; }

      ul { list-style-type: none; }
      li.item { min-height: 1em; padding: 0.33em; }
      li.item div { position: relative; margin: 0 0 1em 0; }
      div.avatar { width: 15%; min-height: 3em; float: left; background-color: rgba(0, 128, 64, 0.2);}
      div.content { width: 85%; min-height: 3em; float: left; background-color: rgba(256, 128, 256, 0.2);}

    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var dynamicToken = null;
        var liveContainer = document.getElementById("live");
        var streamsContainer = document.getElementById("streams").children[0];

        var relayoutStreamsForAdditionalElement = function() {
          var length = (streamsContainer.children.length) + 1;
          if (length == 1) {
            streamsContainer.id = "single-stream";
          } else if (length == 2) {
            streamsContainer.id = "double-stream";
          } else if (length <= 4) {
            streamsContainer.id = "quad-stream";
          } else if (length > 4 && length <= 6) {
            streamsContainer.id = "six-stream";
          } else if (length > 6 && length <= 9) {
            streamsContainer.id = "nine-stream";
          } else if (length > 9 && length <= 12) {
            streamsContainer.id = "twelve-stream";
          } else {
            throw ("max video streams: " + length);
          }
        };

        var createNewStreamDiv = function() {
          relayoutStreamsForAdditionalElement();
          var newStreamDiv = document.createElement('div');
          newStreamDiv.className = "stream";
          streamsContainer.appendChild(newStreamDiv);
          var newStreamRepl = document.createElement('div');
          newStreamDiv.appendChild(newStreamRepl);
          return newStreamRepl;
        }

        var getSessionToken = function(gotSessionFunc) {
          var req = new XMLHttpRequest();
          req.open("POST", "/session", true);
          req.onreadystatechange = function(e) {
            if (this.readyState == 4) {
              gotSessionFunc(req.responseText);
            }
          };
          req.send();
        };

        var loadTokBox = function(sessionId) {
          var publisher;
          var subscribers = {};
          var apiKey = 15935611;
          var token = 'devtoken';
          var session = null;

          if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
            alert("You don't have the minimum requirements to run this application." + "Please upgrade to the latest version of Flash.");
          } else {
            session = TB.initSession(sessionId);  // Initialize session

            // Add event listeners to the session
            session.addEventListener('sessionConnected', sessionConnectedHandler);
            session.addEventListener('sessionDisconnected', sessionDisconnectedHandler);
            session.addEventListener('connectionCreated', connectionCreatedHandler);
            session.addEventListener('connectionDestroyed', connectionDestroyedHandler);
            session.addEventListener('streamCreated', streamCreatedHandler);
            session.addEventListener('streamDestroyed', streamDestroyedHandler);

            session.connect(apiKey, token);
          }

          // Called when user wants to start publishing to the session
          function startPublishing() {
            if (!publisher) {
              var parentDiv = document.getElementById("myself");
              var publisherDiv = document.createElement('div');
              var publisherDivDiv = document.createElement('div');
              publisherDivDiv.setAttribute('id', "publisher-repl");
              publisherDiv.setAttribute('id', 'publisher');
              publisherDiv.appendChild(publisherDivDiv);
              parentDiv.insertBefore(publisherDiv, parentDiv.firstChild);
              publisher = session.publish(publisherDivDiv.id);
              //liveContainer.className = "connected";
            }
          }

          function stopPublishing() {
            if (publisher) {
              session.unpublish(publisher);
            }
            publisher = null;
          }
        
          function sessionConnectedHandler(event) {
            // Subscribe to all streams currently in the Session
            for (var i = 0; i < event.streams.length; i++) {
              addStream(event.streams[i]);
            }
            //show('publishLink');
            startPublishing();
          }

          function streamCreatedHandler(event) {
            // Subscribe to the newly created streams
            for (var i = 0; i < event.streams.length; i++) {
              addStream(event.streams[i]);
            }
          }

          function streamDestroyedHandler(event) {
            // This signals that a stream was destroyed. Any Subscribers will automatically be removed.
            // This default behaviour can be prevented using event.preventDefault()
          }

          function sessionDisconnectedHandler(event) {
            // This signals that the user was disconnected from the Session. Any subscribers and publishers
            // will automatically be removed. This default behaviour can be prevented using event.preventDefault()
            publisher = null;
          }

          function connectionDestroyedHandler(event) {
            // This signals that connections were destroyed
          }

          function connectionCreatedHandler(event) {
            // This signals new connections have been created.
          }

          function exceptionHandler(event) {
            alert("Exception: " + event.code + "::" + event.message);
          }

          function addStream(stream) {
            // Check if this is the stream that I am publishing, and if so do not publish.
            if (stream.connection.connectionId == session.connection.connectionId) {
              return;
            }
            var subscriberDiv = createNewStreamDiv();
            subscriberDiv.setAttribute('id', stream.streamId);
            subscribers[stream.streamId] = session.subscribe(stream, subscriberDiv.id); //, {width: ing.div.offsetWidth, height: ing.div.offsetHeight});
          }
        };

        var onGetSession = function(e) {
          e.preventDefault();
          var login = "foo"; //$("#login").val();
          var hash = document.getElementById("freshtag-id").value;
          var namearr = hash.split("#"); // #topic -> ['', topic']
          var topic = namearr[namearr.length - 1]; // get last element from namearr
          var topicDataRef = new Firebase('http://gamma.firebase.com/brickapp/freshtag/topics/' + topic);
          topicDataRef.on("value", function(snapshot) {
            var foundSession = snapshot.val();
            if (foundSession != null) {
              // if found use that session id
              //console.log("using", login, topic, foundSession);
              loadTokBox(foundSession);
            } else {
              getSessionToken(function(newSession) {
                //console.log("making", login, topic, newSession)
                topicDataRef.set(newSession);
              });
            }
          });

          return false;
        };

        document.getElementById("connect-form").onsubmit = onGetSession;
      });
    </script>
  </head>
  <body>
    <div id="home">
      <div id="myself">
        <div id="status">
          []
        </div>
      </div>
      <div id="freshtag">
        <form id="connect-form">
          <input id="freshtag-id" value="#demo2012"/>
          <input type="submit" id="connect"/>
        </form>
      </div>
      <div id="trending">
        <ul>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                <iframe height="100%" src="http://www.youtube.com/embed/MZUsc1ewgUQ" frameborder="0" allowfullscreen></iframe>
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                <iframe src="http://player.vimeo.com/video/48003887?title=0&amp;byline=0&amp;portrait=0" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
              </p>
            </div>
          </li>
        </ul>
      </div>
    </div>
    <div id="live">
      <div id="streams">
        <div id="single-stream" class="streams-container">
        </div>
      </div>
      <div id="feed">
        <ul>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                words
              </p>
              <p>
                <a href="http://imgur.com/6qxXp"><img src="http://i.imgur.com/6qxXp.jpg" alt="" title="Hosted by imgur.com" /></a>
              </p>
              <p>
                <a href="http://imgur.com/LTR4P"><img src="http://i.imgur.com/LTR4P.jpg" alt="" title="Hosted by imgur.com" /></a>
              </p>
              <p>
                wang chung
                wang chung
                <br/>
                wang chung
              </p>
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
            lol chung
            </div>
          </li>
          <li class="item">
            <div class="avatar">
            []
            </div>
            <div class="content">
              <p>
                wang chung
                <br/>
                wang chung
              </p>
              <p>
                <iframe src="http://player.vimeo.com/video/45684387?title=0&amp;byline=0&amp;portrait=0" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
              </p>
            </div>
          </li>
        </ul>
      </div>
      <div id="input">
        <form>
          <textarea></textarea>
        </form
      </div>
    </div>
  </body>
</html>
